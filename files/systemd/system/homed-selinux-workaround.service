[Unit]
Description=Workaround systemd-homed executables not having the correct SELinux label
ConditionFileIsExecutable=/usr/lib/systemd/systemd-homed
After=local-fs.target

[Service]
Type=oneshot
# Copy if it doesn't exist
ExecStartPre=/usr/bin/bash -c "[ -x /usr/local/bin/overrides/systemd-homed ] || /usr/bin/cp /usr/lib/systemd/systemd-homed /usr/local/bin/overrides/systemd-homed"
ExecStartPre=/usr/bin/bash -c "[ -x /usr/local/bin/overrides/systemd-homework ] || /usr/bin/cp /usr/lib/systemd/systemd-homework /usr/local/bin/overrides/systemd-homework"
ExecStartPre=/usr/bin/bash -c "[ -x /usr/local/bin/overrides/systemd-homed.service ] || /usr/bin/cp /usr/lib/systemd/system/systemd-homed.service /usr/local/bin/overrides/systemd-homed.service"
ExecStartPre=/usr/bin/bash -c "[ -x /usr/local/bin/overrides/systemd-homed-activate.service ] || /usr/bin/cp /usr/lib/systemd/system/systemd-homed-activate.service /usr/local/bin/overrides/systemd-homed-activate.service"
# This is faster than using .mount unit. Also allows for the previous line/cleanup
ExecStartPre=/usr/bin/mount --bind /usr/local/bin/overrides/systemd-homed /usr/lib/systemd/systemd-homed
ExecStartPre=/usr/bin/mount --bind /usr/local/bin/overrides/systemd-homework /usr/lib/systemd/systemd-homework
ExecStartPre=/usr/bin/mount --bind /usr/local/bin/overrides/systemd-homed.service /usr/lib/systemd/system/systemd-homed.service
ExecStartPre=/usr/bin/mount --bind /usr/local/bin/overrides/systemd-homed-activate.service /usr/lib/systemd/system/systemd-homed-activate.service
# Fix SELinux labels
ExecStart=/usr/sbin/restorecon -rv /usr/lib/systemd/systemd-homed /usr/lib/systemd/systemd-homework /usr/lib/systemd/system/systemd-homed.service /usr/lib/systemd/system/systemd-homed-activate.service /var/lib/systemd/home
# Clean-up after ourselves
ExecStart=/usr/bin/umount /usr/lib/systemd/systemd-homed
ExecStart=/usr/bin/umount /usr/lib/systemd/systemd-homework
ExecStart=/usr/bin/umount /usr/lib/systemd/system/systemd-homed.service
ExecStart=/usr/bin/umount /usr/lib/systemd/system/systemd-homed-activate.service
ExecStart=/usr/bin/rm /usr/local/bin/overrides/systemd-homed
ExecStart=/usr/bin/rm /usr/local/bin/overrides/systemd-homework
ExecStart=/usr/bin/rm /usr/local/bin/overrides/systemd-homed.service
ExecStart=/usr/bin/rm /usr/local/bin/overrides/systemd-homed-activate.service
RemainAfterExit=yes

[Install]
WantedBy=systemd-homed.service
